# readme

## 概览 

本次负责三个模块：

module_podcast：播客界面的搭建

module_login：登录模块

lib_music：音频播放模块

## 技术栈

**采用MVVM架构** —— 数据驱动UI

**paging3 + flow** —— 用于部分recycleview的数据加载

**retrofit + flow(stateflow)** ——用于网络请求

**CoroutineScope** —— 用于实现某些简单的异步延时任务

**Android ForegroundService** —— service联动通知栏

**rxjava** —— 部分网络请求+room数据库的写入操作

**简单的自定义dialog**

**LiveData** —— 各种状态位的记录与观察

**简单的属性动画** —— 音频播放界面图片的平移切换

**原生MediaPlay**

**RV的concatAdapter和ListAdapter**

**简单ARouter IProvide的实现** —— 详见module_login模块下的route包

## 详细介绍

### login模块

login模块定义了实现了四种登录方式（严格来说是，验证码登录和手机号密码登录一直请求不到code=200的response）：

- 手机号验证码登录
- 网易云邮箱密码登录，登陆成功会有提示
- 手机号密码登录，
- 匿名登录（游客模式）

实现的功能有：

- ###### 输入框的非空检测，空输入框无法直接点击登录按钮

- ###### CheckBox的状态检测：用于检测用户是否同意一些服务条框

- ###### 获取验证码按钮的一般逻辑，即点击后的一分钟禁用

- ###### 手机号的合法性判断，要求必须是11位的中国大陆地区的手机号码格式

- ###### 右上角的游客登录

- ###### 防抖点击，即连续的时间段内只响应第一次的点击（来源于郭神的项目工具）



![img1](formatChcek.gif)

![img2](loginOther.gif)

受限于gif的大小，上面提到的login模块其他功能就不在此展示了，说一下上面提到的那些功能的实现思路：

1. ###### 输入框的非空检测：用livedata存一个  记录输入框是否有空的状态位，在edit框的回调方法中更新该livedata的值，观察该livedata，让这个状态位与登录按钮的enable属性挂钩

2. ###### 手机号的合法性判断：写个工具方法，用字符串的正则匹配

3. ###### 获取验证码按钮的点击后的一分钟禁用（附带更新UI）：写一个方法，传入lambda，开一个在主线程的携程，在携程作用域里执行该lambda并挂起对应的时间，更新button的text的代码写在lambda里

4. ###### 防抖点击：记录每次点击的时间，连续两次的点击时间之差大于给定时间间隔才放行，否则不予设置onclick回调

5. ###### CheckBox的状态检测与底部弹窗的联动：同第一点，设置一个livedata<Boolean>存放状态位，联动checkbox的回调，至于底部弹窗就是一个设置了一些参数的AlertDialog



缺点：

- 除了匿名登录、验证码的获取与校验这三个网络请求功能之外，其他涉及到网络请求的接口都拒绝接入，一直返回-460，，得不到正常的response data，倒是邮箱登录时不时成功一次，但更多时候都显示登录有风险，这就导致登录功能基本没法用

- 由于该login界面是我仿照网易云的旧版登录ui做的，看起来会很糙，毕竟不会写自定义view

- 这部分的网络请求部分是用的携程的flow写的，viewmodel里很多样板代码，不过难受的不是这点，比起RXjava，flow调试网络请求定位错误类型不太好搞，当时一个gson类型解析错误我都找了好久……

  

### podcast模块

没啥好说的，就是上面一个ViewPager2，下面是用concatAdapter连接起来的一个RecycleView，下面的Rv封面图片上有播放量信息，点击进去后是一个协调者布局加载这个电台所属的节目列表，用到了共享动画元素，上面的VP用到了pagetransform实现了一定的缩放和透明功能

- VP的无限右滑
- RV的组合，可点击
- RV的item点击后进入电台详情页面，是一个简单的协调者布局，点击跳转的过程中图片作为共享动画

![img3](podcastDisplay.gif)

#### 

1. ###### 无限右滑实现方法：获取数据之后在adapter中，返回的item数量为Int.MAX_VALUE，getHolder方法将viewpager的页面加载的数据在已有的数据列表中对列表长度取余做到无限循环，VP的滑动动画效果倒是可以去网上搜搜怎么实现，这个不难

2. ###### RV的组合：这个倒没什么好说的，就是得注意传入的列表数据类型，要保证这些数据被adapter处理后可以正常使用

3. ###### 共享元素动画：给需要共享的控件加一个transitionname，然后就是跳转的时候加几行代码，简单地用了一下

4. ###### CoordinateLayout：这部分内容倒是问的我的队友，刚开始听说的时候去网上找博客看的一脸懵逼，到现在还不时特别会用，只是大概明白了在AppBarLayout里面放置CollapsingToolbarLayout，就可以在往下滑动的过程实现在CollapsingToolbarLayout开始处悬停，而且听我的队友说这里还有坑，如果套nestscrollview的话，会一次性渲染所有内容，这样就不能配合paging使用了，要不然就会一直刷新item

   ###### 





缺点：

- 没有做到本地缓存，这部分也没有数据库

- 如上面看到的，从上往下一个个分析，顶部的VP没有点击事件，这东西我原先是想照着网易云的那个可以直接点击播放来着（尽管这个播放逻辑是已经写出来了的，但这个页面是fragment，不好让ui与其适配）但最终由于没时间去做了，就搁置了没有实现
- RV部分的数据没有实现手动刷新，一个是因为没时间写，另外就是由于目前用到的这几个接口请求到的数据是固定不变的……而且有些字段被废弃了，根本没有数据就返回



### lib_music

这个模块占了我大头的时间，主要是实现播放的service与其联动的Activity由于我的代码太垃圾经常发生内存泄漏，搞了好几天才找到有效的修复的方法，所以觉得挺对不起队友的……

实现的功能有：

- 一个音乐播放器基本的播放、暂停、上一项、下一项、三种播放模式

- 进度条跟随播放进度、拖动进度条改变播放进度、音频基本信息的更新展示

- 简易的播放列表，一个继承了bottomsheetdialog的简单dialog

- 简单的播放动画（旋转、切换歌曲平移）、播放记录的数据写入（基于room数据库的）

- 通知栏建立音乐通知与播放器联动

  效果图：

  ![img4](audioPlayPage1.gif)

  ![img5](audioPlayPage2.gif)

另外的通知栏不知道为啥在我本人的手机上不给看，但在我队友的手机上确实可以正常使用，故这里不做演示

以上所用到的播放器类都是MediaPlayer，未涉及第三方音频播放器库

关于上面的功能实现，我只说把代码写出来了，但代码可读性很差，而且为了让service能脱离播放界面（Activity）与外界进行信息传递，保证MediaPlayer在异步准备时不会由于还未准备好直接获取player状态导致异常，service里写了很多比较乱的代码。就异步通信这一点我当时就没处理好，导致小黄鸟连续叫了几天，现在会想起那几天都快魔怔了#*^#*

## 感悟

学到了很多新东西(也发现以前存在缺漏的地方)

关于协程

这次项目中，由于我的队友在携程使用方面非常牛比，平时有遇到这方面的问题都是找队友问，这也逐渐让我有了一点携程基础，直到该怎么用携程（这里专指携程中的flow）写出比较简洁的网络请求代码。不过在这个过程中，肯定还是有遇到过一些问题，这个时候就也会用到Rxjava对错误进行定位定性的分析。这个过程也让我渐渐熟悉了Rxjava和携程之间的区别，Rxjava的写法带买辆会更多， 但其对网络请求的一般化处理也相对会更完备，只需要重写对应的方法就可以达到效果。携程中的flo可以让我们用更简洁的操作实现异步，对于简单的引用场景来说应该时够用了，但很多时候想要用flow得到更完备结果就需要处理更多东西，比如说断网的时候，rxjava中一般我们都会重写onError方法，但是flow中不一样，flow需要我们有意识的去处理，要么使用catch捕获异常，或者在协程作用域的上下文中传入异常处理对象。

关于多人开发

说实话，多人开发是真的问题频频，时刻都可能会因为某些特殊情况导致发生一些不可预料的问题，很感谢和我并肩作战的大腿队友，没有因为我垃圾就抛弃我，一直在带着我跑，反倒是我感觉比较愧疚，毕竟这次我负责的ARouter基本没有在本次项目中用上（由于当时规划多模块项目的时候出了一些偏差）

关于面临新事物

说实话，这个项目中我学到了很多很多东西。协调者布局是现学的，虽然没有学懂，Service在以前基本没怎么写过，结果一写起来才发现问题多多，不过也积累了宝贵经验，还有通知这部分，也正是有这次的考核我才有机会去专门关注这方面的知识，以前碰到则会些内容都是意思意思下敷衍了事，但也正是借着这次考核的机会，把之前略过的内容好好学一遍

关于美观

说实话，这个项目中学到了很多美观上的东西，屏幕边距，圆角，阴影，边框，还有很多materialdesign的东西，学到的真的太多了。

关于内存泄漏

讲真，这次开发遇到的内存泄漏已经比我以前遇到的内存泄漏问题都要多，不过也正是这次解决内存泄漏的经历让我有了痛彻心扉的教训，目前的话这个app正常使用大抵是没有内存泄漏的，说实话，解决了不少的内存泄漏，有service没有取消绑定的，有动画没有取消的，有handler切换页面没有移除的、handler的任务队列没有及时取消的……希望不要再有奇奇怪怪的内存泄漏把。

## 不足

说实话，这次的考核我写的很乱，比半期考核的时候差多了

没有很炫酷的动画，项目中只写了一个平移的动画和一个共享元素动画。

基本没使用的正经的自定义view，只靠着继承bottomsheetdialog写了个可滑动的底部弹出列表

开发进度太拖沓，基本靠另一个队友包揽大部分进度

对handler的理解不到位，导致在lib_music写这个的时候内存泄漏问题频出，虽然最后解决了，但花了几天时间在这上面

关于Service的了解不够，基本啥代码都往service里面加，结构很乱

对于通知使用到的RemoteView了解不多，导致有时候这个东西出为题不知道该怎么解决

podcast模块有很多功能未实现

没有好好整理一下代码，说实话写的非常丑陋



















